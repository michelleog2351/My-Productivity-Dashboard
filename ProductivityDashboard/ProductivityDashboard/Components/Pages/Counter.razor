@page "/counter"
@rendermode InteractiveServer

<PageTitle>Dashboard</PageTitle>

<style>
    .circular-progress-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .circular-progress {
        width: 220px;
        height: 220px;
        border-radius: 50%;
        background: conic-gradient( #4caf50 @progressPercentage%, #e0e0e0 @progressPercentage% 100% );
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        margin: 20px auto;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* Slight offset, darker shadow */
        transition: background 3s ease-in-out;
    }

        .circular-progress::before {
            content: '';
            width: 140px;
            height: 140px;
            background-color: #fff; /* Match this with the page background color */
            border-radius: 50%;
            position: absolute;
            z-index: 1;
        }

    .progress-percent {
        z-index: 2;
        font-family: Tahoma;
        font-size: 20px;
        font-weight: bold;
        color: #000;
    }

    .progress-text {
        margin-top: 10px;
        margin-bottom: 10px;
        font-size: 20px;
        font-weight: bold;
        color: #4caf50;
    }

    .add-view-tasks-btn{
        transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease; /* Smooth transition for the effects */
        border-radius: 5px;
        margin-bottom: 15px;
    }
    
        .add-view-tasks-btn:hover {
            background-color: #0056b3; /* Darker blue on hover */
            transform: scale(1.1); /* Slightly increase the size */
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.2); /* Add a shadow effect */
        }
</style>
@if(!hasEnteredName)
{
    <div class="welcome-to-dashboard">
        <h1><strong>Welcome! Please enter your name to proceed to your productivity dashboard :)</strong></h1>
        <input type="text" @bind="userName" placeholder="Your Name" />
        <button class="btn btn-primary" @onclick="SubmitName">Submit</button>
    </div>
}

else{
    <h1><strong>Dashboard</strong></h1>
        <h2>Hello, @userName! Welcome to your dashboard.</h2>
    <h3 style="color: grey;">Today, @CurrentDateTime</h3>

    <div class="circular-progress-wrapper">
        <h2><strong>My Task Progress</strong></h2>
        <div class="circular-progress" role="progressbar" 
        aria-label="Total task progress" 
        aria-valuemin="0" 
        aria-valuemax="100"
             title="@GetProgressText()">

            <span class="progress-percent">@GetProgressPercentage().ToString("0")%</span>
        </div>
        <span class="progress-text">@GetProgressText()</span>

        @* Button to reveal tasks section *@
        <button class="btn btn-primary add-view-tasks-btn" type="button" @onclick="ShowTaskSection"><strong>Add & View My Tasks</strong></button>
    </div>

    @if (isTaskSectionVisible)
    {
        <div class="tasks-section">
            <div class="set-task-goal mb-3">
                <label for="taskGoal"><strong>So, how many tasks do you aim to complete today?</strong></label>
                <input type="number" class="form-control" id="taskGoal" @bind="taskGoal" min="1" />
            </div>

            <div class="task-list">
                <ul>
                    @foreach (var task in tasksBusiness.GetTasks())
                    {
                        <li>
                             @if (task.Id == editTaskId)
                            {
                                <form class="form-inline">
                                    <div class="form-group mr-2">
                                        <input type="text" class="form-control" placeholder="Edit Title" @bind="editTaskTitle" name="edit-title" autocomplete="on" />
                                    </div>

                                    <div class="form-group">
                                        <textarea class="form-control" placeholder="Edit Description" @bind="editTaskDescription" name="edit-desc" autocomplete="on" />
                                    </div>

                                    <button type="button" class="btn btn-success" @onclick="SaveTaskEdit">Save</button>
                                    <button type="button" class="btn btn-danger" @onclick="CancelEdit">Cancel</button>
                                </form>
                            }
                            else
                            {
                                <input type="checkbox" @onchange="() => MarkTaskCompleted(task.Id)" /> @task.Title
                                @if (task.IsCompleted && task.CompletedDate != null)
                                {
                                    <span>(Completed on @task.CompletedDate?.ToString("MMMM dd yyyy hh:mm:ss"))</span>
                                }
                                <div>
                                <button type="button" class="btn btn-primary" @onclick="() => StartEditTask(task.Id, task.Title, task.Description)">Edit</button>
                                <button type="button" class="btn btn-danger" @onclick="() => DeleteTask(task.Id)">Delete</button>
                                </div>
                            }
                        </li>
                    }
                </ul>
            </div>

            <div class="add-task">
                <h4>Add New Task</h4>
                <form class="form-inline">
                    <div class="form-group mr-2">
                        <input type="text" class="form-control mb-2" placeholder="Title*" @bind="newTaskTitle" name="add-task" autocomplete="on" />
                    </div>

                    <div class="form-group">
                        <textarea class="form-control mb-2" placeholder="Description (optional)" @bind="newTaskDescription" name="task-desc" autocomplete="on" />
                    </div>
                </form>
                @* <span class="notification text-danger"
                      style="display:@(showNotification ? "block" : "none") margin-bottom: 15px;">
                    <strong>Note:</strong> You have reached your task goal! Please increase your goal if you wish to add more tasks.
                </span>
                <strong>Note:</strong> You have reached your task goal! Please increase your goal if you wish to add more tasks. *@

                <div class="notification" style="color:red; margin-bottom: 15px; display:@(showNotification ? "block" : "none");">
                    <strong>Note:</strong> YO! You have reached your task goal! Increase your no.tasks goals if you wish to add more tasks.
                </div>


                <button class="btn btn-primary" disabled="@IsAddTaskButtonDisabled" @onclick="AddTask">Add Task</button>
            </div>
        </div>
    }
}
@code {
    private bool hasEnteredName = false; // Set to track if the user has entered in their name
    private string userName = ""; 
    private bool isTaskSectionVisible = false; // State to control the visibility of the task section
    private int taskGoal = 1;  // Variable to store the user's goal (default value)
    private string progressText => GetProgressText();
    private double progressPercentage => GetProgressPercentage();
  //  private string progressGradient => GetProgressGradient();
    private int completedTasks => tasksBusiness.GetCompletedTaskCount(); // Get the completed tasks count

    private string newTaskTitle = string.Empty;
    private string newTaskDescription = string.Empty;
    private bool IsAddTaskButtonDisabled => string.IsNullOrWhiteSpace(newTaskTitle);
    private bool showNotification = false;

    // Edit Task variables
    private int editTaskId = -1; // used to track which task is being eidted
    private string editTaskTitle = string.Empty;
    private string editTaskDescription = string.Empty;

    private TasksBusiness tasksBusiness = new(); // Create a new instance

    private string CurrentDateTime => DateTime.Now.ToString("MMMM dd yyyy, hh:mm:ss tt");

    private void SubmitName()
    {
        if (!string.IsNullOrWhiteSpace(userName))
        {
            hasEnteredName = true; // Set to true to reveal the dashboard
        }
    }

    protected override void OnInitialized()
    {
        var timer = new System.Timers.Timer(1000); // Set the timer to update every 1 second
        timer.Elapsed += UpdateTime; // This will pass both sender and ElapsedEventArgs to the method
        timer.Start();
    }

    private void UpdateTime(object? sender, System.Timers.ElapsedEventArgs e) => InvokeAsync(StateHasChanged);

    private void AddTask()
    {
        if (tasksBusiness.GetTasks().Count >= taskGoal)
        {
            // Show notification when trying to add more tasks than the goal
            showNotification = true;
        }
        else if (!string.IsNullOrWhiteSpace(newTaskTitle))
        {
            tasksBusiness.AddTask(newTaskTitle, newTaskDescription);
            newTaskTitle = string.Empty;
            newTaskDescription = string.Empty;

            // Hide notification if task is successfully added
            showNotification = false;
        }
    }


    private string GetProgressText()
    {
        return completedTasks >= taskGoal
            ? "Well done! \n You have completed all of today's tasks!"
            : $"{completedTasks} of {taskGoal} tasks completed";
    }

    private double GetProgressPercentage()
    {
        int completedTasks = tasksBusiness.GetCompletedTaskCount();
        return taskGoal > 0 ? (double)completedTasks / taskGoal * 100 : 0;
    }

    // Get the progress percentage and update the gradient background
    // private string GetProgressGradient()
    // {
    //     double progressPercentage = taskGoal > 0 ? (double)completedTasks / taskGoal * 100 : 0;
    //     //StateHasChanged(); // Force re-render to apply the CSS transition
    //     return $"conic-gradient(#4caf50 0% {progressPercentage}%, #e0e0e0 {progressPercentage}% 100%)";
    // }

    private string GetEndOffset()
    {
        double completedPercentage = (completedTasks / (double)taskGoal) * 100.0;
        double radians = completedPercentage * 3.6 * (Math.PI / 180.0); // Convert percentage to radians
        double radius = 75.0; // Half of the progress bar size
        double offset = radius * Math.Sin(radians); // Calculate offset based on radius and angle
        return $"{offset}px"; // Return as CSS-compatible string
    }

    private void ShowTaskSection()
    {
        isTaskSectionVisible = !isTaskSectionVisible;
    }

    private void StartEditTask(int id, string title, string description)
    {
        editTaskId = id;
        editTaskTitle = title;
        editTaskDescription = description;
    }

    private void SaveTaskEdit()
    {
        tasksBusiness.EditTask(editTaskId, editTaskTitle, editTaskDescription);
        CancelEdit(); // Clear edit state after saving, resetting Edit mode
    }

    private void CancelEdit()
    {
        editTaskId = -1;
        editTaskTitle = "";
        editTaskDescription = "";
    }

    private void DeleteTask(int id)
    {
        tasksBusiness.DeleteTask(id);
    }

    private void MarkTaskCompleted(int id)
    {
        tasksBusiness.MarkTaskCompleted(id);
    }

    // Create Task Model
    public class TaskItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty; // Initialize to an empty string to avoid nulls
        public string Description { get; set; } = string.Empty; // Initialize to an empty string to avoid nulls
        public bool IsCompleted { get; set; } = false;
        public DateTime? CreatedDate { get; set; } = DateTime.Now;
        public DateTime? CompletedDate { get; set; } 
    }


    public class TasksBusiness
    {
        private List<TaskItem> tasks = new();   
        private int nextId = 1;

        public List<TaskItem> GetTasks() => tasks;

        public void AddTask(string title, string description) => tasks.Add(new TaskItem { Id = nextId++, Title = title, Description = description });

        public void EditTask(int id, string title, string description)
        {
            var task = tasks.FirstOrDefault(t => t.Id == id);
            if (task != null)
            { 
                task.Title = title;
                task.Description = description;
            }
        }

        public void DeleteTask(int id)
        {
            var task = tasks.FirstOrDefault(t => t.Id == id);
            if (task != null)
            {
                tasks.Remove(task);
            }
        }

        public void MarkTaskCompleted(int id)
        {
            var task = tasks.FirstOrDefault(t => t.Id == id);
            if (task != null)
            {
                task.IsCompleted = !task.IsCompleted;
                task.CompletedDate = task.IsCompleted ? DateTime.Now : null;
            }
        }

        public int GetCompletedTaskCount() => tasks.Count(t => t.IsCompleted);

    }
}
